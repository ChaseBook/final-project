---
title: "Draft Exploration"
author: "Chase Bookin"
date: "March 21, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidycensus)
library(ggthemes)
library(ggplot2)
library(janitor)
library(dplyr)
library(gt)
library(readxl)
library(sf)
library(scales)
library(magrittr)
library(haven)
library(infer)
library(Lahman)
library(xml2)
library(rvest)
library(DataCombine)
library(RColorBrewer)
library(usmap)
```


```{r, include=FALSE}

# combining hitting and pitching war for each player-season

batting_war <- read_csv("data/bat_war.csv") %>%
  mutate(bat_war = as.numeric(WAR))

pitching_war <- read_csv("data/pitch_war.csv") %>%
  mutate(pitch_war = as.numeric(WAR)) %>%
  select(mlb_ID, year_ID, pitch_war)

war <- batting_war %>%
  full_join(pitching_war, by = c("mlb_ID", "year_ID")) %>%
  mutate(bat_war = ifelse(is.na(bat_war), 0, bat_war)) %>%
  mutate(pitch_war = ifelse(is.na(pitch_war), 0, pitch_war)) %>%
  mutate(war = bat_war + pitch_war)
```


```{r, include=FALSE}

draft <- read_csv("data/draft_register.csv") %>%
  clean_names()

# grouping war data by player and summing career games played and war
# NOTE: I filtered out NA war observations so the summarized war would not also
# be NA due to a single NA observation of war

war_joined <- war %>%
  group_by(mlb_ID) %>%
  filter(!is.na(war)) %>%
  summarize(g = sum(G),
            war = sum(as.numeric(war)))

```

```{r, include=FALSE}

# joined draft and war data by player mlb ID, then mutated teamname to condense
# the Angel's team names into a single team. I then arranged the data by year,
# grouped by player_id, and mutated a column called draft_mumber based on the
# row number (or occurence of that player's id) in the data. I did this because
# I wanted a column that tells for each draft a player is selected in, that it
# is the nth time that player has been selected. For example, if a player turns
# down the draft out of high school, after a year of junior college, and gets
# drafted after his junior year the draft_numb column should say 1,2,3 for each
# respective draft.

master <- draft %>%
  left_join(war_joined, by = c("mlbid" = "mlb_ID")) %>%
  mutate(teamname = as.factor(case_when(teamname %in% c("California Angels",
                                                        "Anahaim Angels",
                                                        "Los Angeles Angels of Anaheim") ~
                                                          "Los Angeles Angels",
                                        TRUE ~ teamname))) %>%
  arrange(year) %>%
  group_by(player_id) %>%
  mutate(draft_numb = row_number()) %>%
  ungroup()

# deleting useless columns

master$mlbid_1 <- NULL
master$x27 <- NULL


```


```{r, include=FALSE}

# adding in age of MLB debut season

debut <- war %>%
  group_by(mlb_ID) %>%
  summarize(debut = min(age))

master <- master %>%
  left_join(debut, by = c("mlbid" = "mlb_ID"))
```


```{r, include=FALSE}

# Making table of only mlb_ID and the player's first and final year in the MLB
# to derive MLB career length and join to master.

# NOTE: I kept getting more observations in the new master set after joining
# mlb_career with the left join because guys who played for multiple teams in
# their first or last year were counted that many times in the data so they
# matched multiple times when joined. Therefore, I grouped each set by mlb_ID
# and year and sliced only one observation - it didn't matter which because we
# only need the year.

mlb_start <- war %>%
  filter(!is.na(mlb_ID)) %>%
  group_by(mlb_ID) %>%
  filter(year_ID == min(year_ID)) %>%
  select(mlb_ID, year_ID) %>%
  rename(mlb_start = year_ID) %>%
  group_by(mlb_ID, mlb_start) %>%
  slice(1) %>%
  ungroup()

mlb_end <- war %>%
  filter(!is.na(mlb_ID)) %>%
  group_by(mlb_ID) %>%
  filter(year_ID == max(year_ID)) %>%
  select(mlb_ID, year_ID) %>%
  rename(mlb_end = year_ID) %>%
  group_by(mlb_ID, mlb_end) %>%
  slice(1) %>%
  ungroup()


# joined mlb first year and last year to create career_length by subtracting
# first year from last year in MLB and adding 1 so if career was 1999 only it
# counts as one season.

mlb_career <- mlb_start %>%
  left_join(mlb_end, by = "mlb_ID") %>%
  mutate(mlb_length = mlb_end - mlb_start + 1) %>%
  select(mlb_ID, mlb_start, mlb_end, mlb_length)

# joining mlb career length set to master table

master <- master %>%
  left_join(mlb_career, by = c("mlbid" = "mlb_ID"))

```


```{r, include=FALSE}

# Using Lahman Fielding dataset to collect player positions Grouped the data by
# player and found the mid career year to get an estimate for what their true
# position is. I then filtered each grouped player's data for their mid career
# year and the row of the position they played the most games at in that season
# (the table has a row for each position a player played each season). I then
# selected the playerID and POS columns to then join to the war dataset which
# contains matching player IDs. Unfortunately the Lahman table does not contain
# MLB IDs or matching player IDs so I need to go through the war table to match
# the player ID to the MLB ID.

fielding <- Fielding %>%
  group_by(playerID) %>%
  mutate(mid_career = round(((max(yearID) + min(yearID)) / 2), 0)) %>%
  filter(yearID == mid_career) %>%
  arrange(desc(G)) %>%
  slice(1) %>%
  select(playerID, POS)

# joining fielding to war to get mlb ID attached to position

war <- war %>%
  left_join(fielding, by = c("player_ID" = "playerID"))


# making war positions joinable to master by ensuring each MLB ID shows up only
# once. I grouped by mlb id and sliced a single row because all have the same
# position for a given player

war_positions <- war %>%
  group_by(mlb_ID) %>%
  slice(1) %>%
  select(mlb_ID, POS)


# Joining the war_positions table to master by mlb ID and renamed position

master <- master %>%
  left_join(war_positions, by = c("mlbid" = "mlb_ID")) %>%
  rename(position = POS)

```



```{r, echo=FALSE}
draft_2000_2012 <- draft %>%
  filter(year >= 1990 & year <= 2011)

draft_2000_2012 <- draft_2000_2012 %>%
  filter(!is.na(high_level)) %>%
  filter(draft_round <= 50) %>%
  mutate(mlb_made = ifelse(high_level == "MLB", 1, 0)) %>%
  mutate(ignore = 1) %>%
  group_by(draft_round) %>%
  summarize(percent_mlb = sum(mlb_made) / sum(ignore))

ggplot(draft_2000_2012, mapping = aes(draft_round, percent_mlb)) +
  geom_col() +
  theme_economist_white() +
  labs(
    x = "Draft Round",
    y = "Percent to reach Major Leagues",
    title = "Percent of Draft Picks by Round to Reach the Majors",
    subtitle = "Data from 1990-2011 drafts"
  ) 
```

```{r, echo=FALSE}
grow_talent <- master %>%
  filter(source == "H" & signed == "Y") %>%
  mutate(decade = ifelse(year %in% 1970:1979, 1970,
                                 ifelse(year %in% 1980:1989, 1980,
                                        ifelse(year %in% 1990:1999, 1990,
                                               ifelse(year %in% 2000:2009, 2000,
                                                      ifelse(year %in% 2010:2019, 2010, NA)))))) %>%
  filter(year >= 1980 & year <= 2009) %>%
  mutate(mlb_made = ifelse(high_level == "MLB", 1, 0)) %>%
  mutate(ignore = 1) %>%
  group_by(teamname) %>%
  summarize(mlb = sum(mlb_made), 
            total = sum(ignore),
            percent_mlb = sum(mlb_made) / sum(ignore))

ggplot(grow_talent, mapping = aes(x = reorder(teamname, -percent_mlb), percent_mlb)) +
  geom_col() +
  theme_economist_white() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    x = "Team",
    y = "Percent of High School Picks to MLB",
    title = "Percent of High School Picks to MLB by Team",
    subtitle = "Data: 1980-2009 Drafts"
  )
  
```



```{r, echo=FALSE}

hs_signed <- master %>%
  filter(source == "H" & signed == "Y") %>%
  mutate(mlb_made = ifelse(high_level == "MLB", 1, 0)) 


hs_signed_90_09 <- hs_signed %>%
  mutate(ignore = 1) %>%
  group_by(draft_round) %>%
  filter(year >= 1990 & year <= 2009) %>%
  filter(draft_round <= 40) %>%
  summarize(percent_mlb = sum(mlb_made) / sum(ignore))

ggplot(hs_signed_90_09, mapping = aes(draft_round, percent_mlb)) +
  geom_col() +
  theme_economist_white() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    x = "Round",
    y = "Percent of Signed High School Picks to MLB",
    title = "Percent of Signed High School Picks to MLB by Round",
    subtitle = "Data: 1990-2009 Drafts"
  )

```



```{r, echo=FALSE}
college_signed <- master %>%
  filter(source == "C" & signed == "Y") %>%
  mutate(mlb_made = ifelse(high_level == "MLB", 1, 0)) 


college_signed_90_09 <- college_signed %>%
  mutate(ignore = 1) %>%
  group_by(draft_round) %>%
  filter(year >= 1990 & year <= 2009) %>%
  filter(draft_round <= 40) %>%
  summarize(percent_mlb = sum(mlb_made) / sum(ignore))

ggplot(college_signed_90_09, mapping = aes(draft_round, percent_mlb)) +
  geom_col() +
  theme_economist_white() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    x = "Round",
    y = "Percent of College Picks to MLB",
    title = "Percent of Signed College Picks to MLB by Round",
    subtitle = "Data: 1990-2009 Drafts"
  )

```


```{r, include=FALSE}

# I made a new dataset where I filtered the master set for only unsigned
# highschool picks. I only selected the player_id column. I wanted to do this so
# that I could have a list of IDs and then rejoin these player IDs using a
# left_join to keep only the data from players who did not sign out of high
# school, but all years of their draft data rather than just the draft they
# turned down out of high school. That is what hs_unsigned is.

# NOTE: I added the draft_numb == 1 to the filter because some players (Matt
# Harrington) were drafted out of high school technically and turned down the
# draft multiple times.

unsigned_ids <- master %>%
  filter(source == "H" & signed == "N" & draft_numb == 1) %>%
  select(player_id)

hs_unsigned <- unsigned_ids %>%
  left_join(master, by = "player_id") %>%
  arrange(player_id, desc(year))
```


Findings from master redraft function (can be found in redraft_backup.Rmd) :
50.8 percent of players that turned down the draft out of high school from
1990-2015 were drafted again. 73.3 percent of players that turned down a top 20
round draft pick out of high school from 1990-2015 were drafted again. The
average initial round of top 20 high school picks to turn down the draft was
12.99. When they are redrafted, the average pick is round 16.38, a fair drop.


```{r, include=FALSE}

redraft_master <- function(startyear, endyear = startyear + 4) {
# filtering the unsigned high school data for only draft picks after 1990

hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

# filtered the data of unsigned high school picks with their subsequent drafts
# for only the first instance of the player being drafted, which is the draft
# afte their senior year of high school. For count_redrafted_hs, I filtered for
# draft_numb equal to 2 to see how many players were redrafted after originally
# turning the draft down.

count_unsigned_hs <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & year <= endyear) %>%
  count() %>%
  pull(n)

# I create the ID table and re join it in order to get rid of data for redrafted
# players whose first draft out of high school was before the trim year (1990).

trimyear_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & year <= endyear) %>%
  select(player_id)

count_redrafted_hs <- trimyear_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id") %>%
  filter(draft_numb == 2) %>%
  count() %>%
  pull(n)

percent_redrafted_hs <- round(count_redrafted_hs / count_unsigned_hs * 100, 1)


# below, I repeat the same process for high school players drafted in the top 20
# rounds. I started by filtering the unsigned high school full dataset for only
# the initial high school draft and only those high school players taken in the
# first 20 rounds. I also filtered out players who were drafted out of high
# school after 2015, as it is still possible they are playing in college and may
# be redrafted later. I then re-joined the data to their subsequent drafts and
# found the percent of top 20 round high schoolers who are drafted again. AGAIN,
# only using data from players hwo were initially taken between 1990 and 2015.

# I filtered year less than 2015 to make sure we are selecting only top 20 round
# high school picks who turned down the draft between 1990 and 2015. Their
# subsequent drafts can occur any other year.

unsigned_hs_20_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & draft_round <= 20 & year <= endyear) %>%
  select(player_id)

hs_unsigned_20 <- unsigned_hs_20_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id")


first_draft_unsigned_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 1)

avg_round_20_hs <- first_draft_unsigned_20 %>%
  summarize(mean_round = round(mean(draft_round), 2))%>%
  pull(mean_round)

count_unsigned_20 <- first_draft_unsigned_20 %>%
  count() %>%
  pull(n)

redrafted_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 2)
  
avg_round_redrafted_20 <- redrafted_20 %>%
  summarize(mean_round = round(mean(draft_round),2)) %>%
  pull(mean_round)

count_redrafted_20 <- redrafted_20 %>%
  count() %>%
  pull(n)

percent_redrafted_20 <- round(count_redrafted_20 / count_unsigned_20 * 100, 1)

percent_redrafted_20
}

```


```{r, include=FALSE}

full_redraft_percent <- function(startyear, endyear = startyear + 4) {


hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

count_unsigned_hs <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & year <= endyear) %>%
  count() %>%
  pull(n)

trimyear_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & year <= endyear) %>%
  select(player_id)

count_redrafted_hs <- trimyear_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id") %>%
  filter(draft_numb == 2) %>%
  count() %>%
  pull(n)

percent_redrafted_hs <- round(count_redrafted_hs / count_unsigned_hs * 100, 1)

percent_redrafted_hs

}

full_redraft_percent(1990, 2015)

```

```{r, include=FALSE}
round_redraft_percent <- function(startyear, endyear = startyear + 4, max_round = 20, min_round = 1) {
  
hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

unsigned_hs_20_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & draft_round <= max_round &
           draft_round >= min_round & year <= endyear) %>%
  select(player_id)

hs_unsigned_20 <- unsigned_hs_20_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id")

first_draft_unsigned_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 1)

count_unsigned_20 <- first_draft_unsigned_20 %>%
  count() %>%
  pull(n)

redrafted_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 2)

count_redrafted_20 <- redrafted_20 %>%
  count() %>%
  pull(n)

percent_redrafted_20 <- round(count_redrafted_20 / count_unsigned_20 * 100, 1)

percent_redrafted_20

}

round_redraft_percent(2000, 2004, 5)

```

```{r, include=FALSE}
prior_mean_round <- function(startyear, endyear = startyear + 4, max_round = 20, min_round = 1) {
  
hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

unsigned_hs_20_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & draft_round <= max_round &
           draft_round >= min_round & year <= endyear) %>%
  select(player_id)

hs_unsigned_20 <- unsigned_hs_20_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id")

first_draft_unsigned_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 1)

avg_round_20_hs <- first_draft_unsigned_20 %>%
  summarize(mean_round = round(mean(draft_round), 2))%>%
  pull(mean_round)

avg_round_20_hs

}

prior_mean_round(1990, 2015, 20)
```

```{r, include=FALSE}
post_mean_round <- function(startyear, endyear = startyear + 4, max_round = 20, min_round = 1) {
  
hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

unsigned_hs_20_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & draft_round <= max_round &
           draft_round >= min_round & year <= endyear) %>%
  select(player_id)

hs_unsigned_20 <- unsigned_hs_20_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id")

redrafted_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 2)
  
avg_round_redrafted_20 <- redrafted_20 %>%
  summarize(mean_round = round(mean(draft_round),2)) %>%
  pull(mean_round)

avg_round_redrafted_20
  
}

post_mean_round(1990, 2015, 20)

```


```{r, include=FALSE}

# I made the master redraft_table in this chunk. Started by making a half-decade
# list from 1990 through 20010 which each serve to hold the data for that draft
# and the four following it. I made a tibble starting with these years and added
# a round column. Next, I added a percent redrafted percent column for all
# players who were drafted out of high school and turned it down in that time
# period. I then added a percent redrafted column for players drafted within the
# top 20 rounds of high school within that time period who turned down the draft
# to see the proportion that were redrafted. Finally, I took the same players'
# average initial draft round out of high school, their average draft round the
# next time they were picked, and the difference between them to see how their
# stock changed. I repeated the process for top 10 round high school picks and
# top 5 round high school picks, and then binded the three tables into a single
# table, redraft_table. The table stores the draft year period (2010-2014), high
# school draft round maximum (20th round), percent redrafted of all high school
# players in the period to turn down the draft, percent redrafted of high school
# players drafted before the round cutoff out of high school in the period,
# initial mean draft round, next mean draft round, and difference between the
# two slots. 

# NOTE: I added a min_round / max_round input so that the round data does not overlap. For example, if I have top 5 round data and top 10 round data for a given 5 year period, I want to separate rounds 1-5 from rounds 6-10

half_decade <- c(1990, 1995, 2000, 2005, 2010)
half_decade <- set_names(half_decade, nm = half_decade)

redraft_table_20 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 20) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    max_round = 20,
    min_round = 11), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    max_round = 20,
    min_round = 11),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    max_round = 20,
    min_round = 11),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)
  
  
redraft_table_10 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 10) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    max_round = 10,
    min_round = 6), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    max_round = 10,
    min_round = 6),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    max_round = 10,
    min_round = 6),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)

redraft_table_05 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 5) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    max_round = 5), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    max_round = 5),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    max_round = 5),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)


# I added the ifelse for rounds 40-50 for the average round columns because it
# is possible a player was redrafted after the new Collective Bargaining
# Agreement that cut the draft to 40 rounds. This would make it appear as though
# their jump in draft stock was higher than in reality because there were only
# 40 rounds to be selected from to begin with, implying an automatic draft stock
# boost if redrafted. I only used an ifelse to set 2010 data to NA for percent
# redrafted because we only have one year of data from 2011 in this category.

redraft_table_50 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 50) %>%
  mutate(percent_redrafted = ifelse(start_year == 2010, NA,
                                    map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    max_round = 50,
    min_round = 41), 
    .id = half_decade))) %>%
  mutate(initial_draft_round = ifelse(start_year == 2010 | start_year == 2005, NA,
                                      map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    max_round = 50,
    min_round = 41),
    .id = half_decade))) %>%
  mutate(redraft_round = ifelse(start_year == 2010 | start_year == 2005, NA,
                                map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    max_round = 50,
    min_round = 41),
    .id = half_decade))) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)

redraft_table_30 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 30) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    max_round = 30,
    min_round = 21), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    max_round = 30,
    min_round = 21),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    max_round = 30,
    min_round = 21),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)

redraft_table_40 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 40) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    max_round = 40,
    min_round = 31), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    max_round = 40,
    min_round = 31),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    max_round = 40,
    min_round = 31),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)

redraft_table <- rbind(redraft_table_50,
                       redraft_table_40,
                       redraft_table_30,
                       redraft_table_20, 
                       redraft_table_10, 
                       redraft_table_05)



# order table by round descending and start year ascending to return to standard


```



```{r, echo=FALSE}

# ggplot of redraft probability by set of rounds drafted in out of high school
# and 5 year period in which a player was drafted out of high school.

redraft_table %>%
  ggplot(aes(round, percent_redrafted)) +
  geom_point(na.rm = TRUE) +
  geom_line(aes(group = start_year, color = start_year), na.rm = TRUE) +
  labs(
    x = "Round Range Drafted out of High School",
    y = "Percent of Picks Re-drafted",
    color = "Time Frame",
    title = "High School Re-draft Probability",
    subtitle = "Organized by initial round range and time period"
  ) +
  theme_light() +
  scale_color_viridis_c() +
  scale_x_continuous(breaks = c(5, 10, 20, 30, 40, 50))

```
Notes on graph: most recent 5 years emulates earliest two 5 year periods but much less steep towards back end of draft. Possible explanations are teams taking late draft shots at unsignable top picks or high school picks just maintaining stock better.

```{r, include=FALSE}
ggsave("final_project_shiny/redraft_probability.png")
```



```{r, echo=FALSE}
redraft_table %>%
  ggplot(aes(round, mean_round_diff)) +
  geom_point(na.rm = TRUE) +
  geom_line(aes(group = start_year, color = start_year), na.rm = TRUE) +
  labs(
    x = "Round Range Drafted out of High School",
    y = "Average Improvement Re-draft Round",
    color = "Time Frame",
    title = "Average Change in Round of Re-drafted Unsigned High School Picks",
    subtitle = "Organized by initial round range and time period"
  ) +
  theme_light() +
  scale_color_viridis_c() +
  scale_x_continuous(breaks = c(5, 10, 20, 30, 40, 50)) +
  scale_y_continuous(breaks = c(-10, -5, 0, 10, 20)) +
  geom_hline(color = "red", linetype = "dashed", yintercept = 0)
```


Note estimated intercept with y=0 to see when on average it becomes beneficial
to a player's redraft stock to not sign out of high school. Important to keep in
mind this is for players who are redrafted, so back half of draft improvement
likely partly explained by fewer, the best, initial late round high school picks
being redrafted.

shiny link:

https://chase-bookin.shinyapps.io/final_project_shiny/


```{r, echo=FALSE}

mlb_percentile_signed <- function(round = 20, startyear = 1990, endyear = 2011) {
  
top_20_signed_total <- master %>%
  filter(source == "H" & signed == "Y") %>%
  filter(draft_round <= round & year >= startyear & year <= endyear) %>%
  count() %>%
  pull(n)

top_20_signed_mlb <- master %>%
  filter(source == "H" & signed == "Y" & high_level == "MLB") %>%
  filter(draft_round <= round & year >= startyear & year <= endyear) %>%
  count() %>%
  pull(n)
  
top_20_signed_mlb / top_20_signed_total

}

mlb_percentile_signed(round = 20, startyear = 1990, endyear = 2011)
# 27.3% of signed top 20 round high school picks from 1990-2010 have made it to MLB

```



```{r, echo=FALSE}

mlb_percentile_unsigned <- function(round = 20, startyear = 1990, endyear = 2011) {
  
top_20_unsigned_total <- master %>%
  filter(source == "H" & signed == "N" & draft_numb == 1) %>%
  filter(draft_round <= round & year >= startyear & year <= endyear) %>%
  count() %>%
  pull(n)

top_20_unsigned_mlb <- master %>%
  filter(source == "H" & signed == "N" & draft_numb == 1 & high_level == "MLB") %>%
  filter(draft_round <= round & year >= startyear & year <= endyear) %>%
  count() %>%
  pull(n)

top_20_unsigned_mlb / top_20_unsigned_total

}
# 22.7% of unsigned top 20 round high school picks from 1990-2010 have made it to MLB

mlb_percentile_unsigned(round = , startyear = 1990, endyear = 2011)
```


```{r, include=FALSE}
# PREPPING master data for peak level distribution in shiny by ordering
# high_level factors

master_peak <- master %>%
  mutate(high_level = ifelse(high_level %in% c("-", "JrCollege", "NAIA", "NCAA"),
                                  "<=College",
                                  high_level)) %>%
  mutate(high_level = factor(high_level, levels = c("<=College",
                                                    "Indy",
                                                    "Rk",
                                                    "A-",
                                                    "A",
                                                    "A+",
                                                    "AA",
                                                    "AAA",
                                                    "MLB")))
                                                               

```


```{r, echo=FALSE}

peak_level <- function(max_round, startyear, endyear, min_round = 1) {
  
top_20_hs <- master %>%
  filter(source == "H" & draft_numb == 1) %>%
  filter(draft_round >= min_round & draft_round <= max_round & year >= startyear & year <= endyear) %>%
  mutate(high_level = ifelse(high_level %in% c("-", "JrCollege", "NAIA", "NCAA"),
                             "<=College",
                             high_level)) %>%
  group_by(signed, high_level) %>%
  summarize(n = n()) %>%
  group_by(signed) %>%
  mutate(y = n/sum(n)) %>%
  mutate(high_level = factor(high_level,levels = c("<=College",
                                                   "Indy",
                                                   "Rk",
                                                   "A-",
                                                   "A",
                                                   "A+",
                                                   "AA",
                                                   "AAA",
                                                   "MLB")))

top_20_hs %>%
  ggplot() +
  geom_col(aes(x = high_level, y = y, fill = signed), position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_light() +
  labs(
    x = "Peak Baseball Level Reached",
    y = "Percentage",
    fill = "Signed?",
    title = "Distribution of Peak Baseball Career Level of High School Picks",
    subtitle = "Grouped by whether or not the player signed out of high school"
  )

}

peak_level(max_round = 20, startyear = 2010, endyear = 2010, min_round = 1)
```




```{r, echo=FALSE}

debut_age <- function(max_round, startyear, endyear, min_round = 1) {
  
debut <- master %>%
  filter(source == "H" & draft_numb == 1 & high_level == "MLB") %>%
  filter(draft_round >= min_round & draft_round <= max_round & year >= startyear & year <= endyear) %>%
  group_by(signed, debut) %>%
  summarize(n = n()) %>%
  group_by(signed) %>%
  mutate(y = n/sum(n))


debut %>%
  ggplot(aes(x = debut, y = y, color = signed)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_continuous(breaks = c(18:30)) +
  theme_light() +
  labs(
    x = "Age During Debut Season",
    y = "Percentage",
    color = "Signed?",
    title = "Distribution of Debut Season Age of High School Picks",
    subtitle = "Grouped by whether or not the player signed out of high school"
  )

}

debut_age(max_round = 40, startyear = 1990, endyear = 2011, min_round = 1)

```


```{r, echo=FALSE}

# I created hs_mlb_length which takes all high school picks who reached majors
# and have not been in the majors since 2017 latest to make it very likely their
# MLB career is over. I then grouped by whether they signed out of high school
# and found some summary stats for the career lengths of each group and career
# WAR.

hs_mlb_length <- master %>%
  filter(source == "H" & draft_numb == 1 & high_level == "MLB") %>%
  filter(mlb_end <= 2017) %>%
  group_by(signed) %>%
  summarize(q1 = quantile(mlb_length, 0.25),
            median_length = median(mlb_length),
            mean_length = mean(mlb_length),
            q3 = quantile(mlb_length, 0.75))

career_length <- function(pos = c("C", "1B", "2B", "3B", "SS", "OF", "P")) {

  hs_mlb_inactive <- master %>%
    filter(source == "H" & draft_numb == 1 & high_level == "MLB") %>%
    filter(position %in% pos) %>%
    filter(mlb_end <= 2017)

  ggplot(hs_mlb_inactive, aes(signed, mlb_length, fill = signed)) +
    geom_boxplot() +
    coord_flip() +
    theme_light() +
    labs(
      x = "Years Played in MLB",
      y = "Signed out of High School?",
      title = "MLB Career Length Summary of High School Picks to Reach MLB",
      subtitle = "Grouped by whether player signed out of high school"
    )

}
 
career_length()
```


```{r, echo=FALSE}

war_summary <- function(pos = c("C", "1B", "2B", "3B", "SS", "OF", "P")) {

  hs_mlb_war <- master %>%
    filter(source == "H" & draft_numb == 1 & high_level == "MLB") %>%
    filter(position %in% pos) %>%
    filter(mlb_end <= 2017) %>%
    group_by(signed) %>%
    summarize(q1 = quantile(war, 0.25),
              median_war = median(war),
              mean_war = mean(war),
              q3 = quantile(war, 0.75))

# Made a gt table of the summary data from the above hs_mlb_war table

  gt(data = hs_mlb_war) %>%
    tab_header(
      title = "Career Wins Above Replacement of High School Picks to Reach MLB"
    ) %>%
    tab_spanner(
      columns = vars(signed, q1, median_war, mean_war, q3),
      label = "Grouped by whether player signed out of high school"
    ) %>%
    cols_label(
      signed = "Signed?",
      q1 = "25th Percentile",
      median_war = "Median",
      mean_war = "Mean",
      q3 = "75th Percentile"
    ) %>%
    fmt_number(
      columns = vars(q1, median_war, mean_war, q3),
      decimals = 2
    )
  
}

war_summary()
```

```{r, echo=FALSE}

# I filtered the master data for signed high school picks before 2012 to make it
# likely they are either in the majors or not in an organization. I grouped by
# draft region, which for high school picks is the abbreviation of their home
# state. I then summarized the total drafted, total to make it to MLB, and the
# percent to MLB. I then joined the summarized data to the statepop data from
# usmap package to get the state names for mapping. I filtered out states with
# fewer than ten draft picks and plotted the data.

statepop <- statepop

state_mlb <- master %>%
  filter(source == "H" & draft_numb == 1 & signed == "Y") %>%
  filter(year <= 2012) %>%
  mutate(mlb_made_numeric = ifelse(high_level == "MLB", 1, 0)) %>%
  group_by(draft_region_id) %>%
  summarize(percent_mlb = sum(mlb_made_numeric) / n(),
            drafted = n(),
            mlb = sum(mlb_made_numeric))

state_mlb <- state_mlb %>%
  left_join(statepop, by = c("draft_region_id" = "abbr"))
  
state_mlb <- state_mlb %>%
  filter(!is.na(full)) %>%
  mutate(full = reorder(full, drafted),
         big_state = ifelse(draft_region_id %in% c("CA", "TX", "FL"), 1, 0)) 

plot_usmap(data = state_mlb %>%
             filter(drafted >= 50),
           values = "percent_mlb", color = "white") + 
  scale_fill_viridis_c() +
  theme(legend.position = "right") +
  labs(
    title = "Probability of Signed High School Picks Reaching the Majors",
    fill = "MLB Probability"
  ) +
  theme_void()
  
```


```{r, echo=FALSE}
state_mlb %>%
  filter(big_state == 0) %>%
  ggplot(aes(full, drafted, color = percent_mlb)) +
  coord_flip() +
  geom_point() +
  scale_y_continuous(breaks = c(0, 50, 100, 150, 200, 250, 300, 350)) +
  theme_gray() +
  theme(axis.text.y = element_text(size = 7.5)) +
  scale_color_viridis_c() +
  labs(
    x = "State",
    y = "Number of Players Drafted",
    title = "Number of High School Players Drafted by State",
    subtitle = "From 1965-2012 - Outliers: (California: 2249, Texas: 627, Florida: 1069)",
    color = "MLB Percent"
  )
```

```{r, include=FALSE}
master %>%
  filter(source == "H" & draft_numb == 1 & high_level == "MLB" & signed == "Y") %>%
  filter(draft_region_id == "MT") %>%
  arrange(desc(year)) %>%
  select(year, draft_round, teamname, first_name, last_name, mlb_length)
```

```{r, echo=FALSE}

# To create redraft_gap, I took the full data of unsigned high school players
# and their subsequent draft selections. I grouped the data by player_id, and
# filtered for only the initial pick and the pick which they eventually signed.
# I also filtered for only players who ultimately made the Major Leagues. I made
# sure there were only two rows per player and subtracted the difference in
# years from their initial draft to when they signed. I filtered out a handful
# of observations in which different players shared an ID and were drafted many
# years apart. I then sliced one observation from each player and found the mean
# of the new signing_gap column.

redraft_gap <- hs_unsigned %>%
  group_by(player_id) %>%
  filter(draft_numb == 1 | signed == "Y") %>%
  filter(high_level == "MLB") %>%
  filter(n() == 2) %>%
  mutate(year = ifelse(year == min(year), year * (-1), year)) %>%
  mutate(signing_gap = sum(year)) %>%
  filter(signing_gap >= -10 & signing_gap < 8) %>%
  slice(1) %>%
  ungroup()

mean_signing_gap <- redraft_gap %>%
  summarize(mean_signing_gap = round(mean(signing_gap), 2)) %>%
  pull(mean_signing_gap)

mean_signing_gap
  
  
```
The most common age unsigned high school players reach the majors is 24, compared to 22 for signed high school picks. Interestingly, of unsigned high school picks that ultimately reach the majors, the average wait 2.84 years before signing again. This suggests that of high school picks that reach the majors, ones that go to college spend less time in the minor leagues. Although they still make their debut at a later age than their peers that sign, college baseball can provide them with experience to rise through the minor leagues more efficiently.


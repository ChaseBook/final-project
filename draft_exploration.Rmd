---
title: "Draft Exploration"
author: "Chase Bookin"
date: "March 21, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidycensus)
library(ggthemes)
library(ggplot2)
library(janitor)
library(dplyr)
library(gt)
library(readxl)
library(sf)
library(scales)
library(magrittr)
library(haven)
library(infer)
library(Lahman)
library(xml2)
library(rvest)
library(DataCombine)
```

```{r, include=FALSE}
war <- read_csv("data/war.csv")
```


```{r, include=FALSE}

draft <- read_csv("data/draft_register.csv") %>%
  clean_names()

# grouping war data by player and summing career games played and war

war_joined <- war %>%
  group_by(mlb_ID) %>%
  summarize(g = sum(G),
            war = sum(as.numeric(WAR)))

```

```{r, include=FALSE}

# joined draft and war data by player mlb ID, then mutated teamname to condense
# the Angel's team names into a single team. I then arranged the data by year,
# grouped by player_id, and mutated a column called draft_mumber based on the
# row number (or occurence of that player's id) in the data. I did this because
# I wanted a column that tells for each draft a player is selected in, that it
# is the nth time that player has been selected. For example, if a player turns
# down the draft out of high school, after a year of junior college, and gets
# drafted after his junior year the draft_numb column should say 1,2,3 for each
# respective draft.

master <- draft %>%
  left_join(war_joined, by = c("mlbid" = "mlb_ID")) %>%
  mutate(teamname = as.factor(case_when(teamname %in% c("California Angels",
                                                        "Anahaim Angels",
                                                        "Los Angeles Angels of Anaheim") ~
                                                          "Los Angeles Angels",
                                        TRUE ~ teamname))) %>%
  arrange(year) %>%
  group_by(player_id) %>%
  mutate(draft_numb = row_number()) %>%
  ungroup()

# deleting useless columns

master$mlbid_1 <- NULL
master$x27 <- NULL

```


```{r, echo=FALSE}
draft_2000_2012 <- draft %>%
  filter(year >= 2000 & year <= 2012)

draft_2000_2012 <- draft_2000_2012 %>%
  mutate(mlb_made = ifelse(high_level == "MLB", 1, 0)) %>%
  mutate(ignore = 1) %>%
  group_by(draft_round) %>%
  summarize(percent_mlb = sum(mlb_made) / sum(ignore))

ggplot(draft_2000_2012, mapping = aes(draft_round, percent_mlb)) +
  geom_col() +
  theme_economist_white() +
  labs(
    x = "Draft Round",
    y = "Percent to reach Major Leagues",
    title = "Percent of Draft Picks by Round to Reach the Majors",
    subtitle = "Data from 2000-2012 drafts"
  ) 
```

```{r, echo=FALSE}
grow_talent <- master %>%
  filter(source == "H" & signed == "Y") %>%
  mutate(decade = ifelse(year %in% 1970:1979, 1970,
                                 ifelse(year %in% 1980:1989, 1980,
                                        ifelse(year %in% 1990:1999, 1990,
                                               ifelse(year %in% 2000:2009, 2000,
                                                      ifelse(year %in% 2010:2019, 2010, NA)))))) %>%
  filter(year >= 1980 & year <= 2009) %>%
  mutate(mlb_made = ifelse(high_level == "MLB", 1, 0)) %>%
  mutate(ignore = 1) %>%
  group_by(teamname) %>%
  summarize(percent_mlb = sum(mlb_made) / sum(ignore))

ggplot(grow_talent, mapping = aes(x = reorder(teamname, -percent_mlb), percent_mlb)) +
  geom_col() +
  theme_economist_white() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    x = "Team",
    y = "Percent of High School Picks to MLB",
    title = "Percent of High School Picks to MLB by Team",
    subtitle = "Data: 1980-2009 Drafts"
  )
  
```



```{r, echo=FALSE}

hs_signed <- master %>%
  filter(source == "H" & signed == "Y") %>%
  mutate(mlb_made = ifelse(high_level == "MLB", 1, 0)) 


hs_signed_90_09 <- hs_signed %>%
  mutate(ignore = 1) %>%
  group_by(draft_round) %>%
  filter(year >= 1990 & year <= 2009) %>%
  filter(draft_round <= 40) %>%
  summarize(percent_mlb = sum(mlb_made) / sum(ignore))

ggplot(hs_signed_90_09, mapping = aes(draft_round, percent_mlb)) +
  geom_col() +
  theme_economist_white() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    x = "Round",
    y = "Percent of Signed High School Picks to MLB",
    title = "Percent of Signed High School Picks to MLB by Round",
    subtitle = "Data: 1980-2009 Drafts"
  )

```

```{r}

# I made a new dataset where I filtered the master set for only unsigned
# highschool picks. I only selected the player_id column. I wanted to do this so
# that I could have a list of IDs and then rejoin these player IDs using a
# left_join to keep only the data from players who did not sign out of high
# school, but all years of their draft data rather than just the draft they
# turned down out of high school. That is what hs_unsigned is.

unsigned_ids <- master %>%
  filter(source == "H" & signed == "N") %>%
  select(player_id)

hs_unsigned <- unsigned_ids %>%
  left_join(master, by = "player_id") %>%
  arrange(player_id, desc(year))
```


```{r}

```

Findings from master redraft function (can be found in redraft_backup.Rmd) :
50.8 percent of players that turned down the draft out of high school from
1990-2015 were drafted again. 73.3 percent of players that turned down a top 20
round draft pick out of high school from 1990-2015 were drafted again. The
average initial round of top 20 high school picks to turn down the draft was
12.99. When they are redrafted, the average pick is round 16.38, a fair drop.


```{r}

redraft_master <- function(startyear, endyear = startyear + 4) {
# filtering the unsigned high school data for only draft picks after 1990

hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

# filtered the data of unsigned high school picks with their subsequent drafts
# for only the first instance of the player being drafted, which is the draft
# afte their senior year of high school. For count_redrafted_hs, I filtered for
# draft_numb equal to 2 to see how many players were redrafted after originally
# turning the draft down.

count_unsigned_hs <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & year <= endyear) %>%
  count() %>%
  pull(n)

# I create the ID table and re join it in order to get rid of data for redrafted
# players whose first draft out of high school was before the trim year (1990).

trimyear_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & year <= endyear) %>%
  select(player_id)

count_redrafted_hs <- trimyear_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id") %>%
  filter(draft_numb == 2) %>%
  count() %>%
  pull(n)

percent_redrafted_hs <- round(count_redrafted_hs / count_unsigned_hs * 100, 1)


# below, I repeat the same process for high school players drafted in the top 20
# rounds. I started by filtering the unsigned high school full dataset for only
# the initial high school draft and only those high school players taken in the
# first 20 rounds. I also filtered out players who were drafted out of high
# school after 2015, as it is still possible they are playing in college and may
# be redrafted later. I then re-joined the data to their subsequent drafts and
# found the percent of top 20 round high schoolers who are drafted again. AGAIN,
# only using data from players hwo were initially taken between 1990 and 2015.

# I filtered year less than 2015 to make sure we are selecting only top 20 round
# high school picks who turned down the draft between 1990 and 2015. Their
# subsequent drafts can occur any other year.

unsigned_hs_20_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & draft_round <= 20 & year <= endyear) %>%
  select(player_id)

hs_unsigned_20 <- unsigned_hs_20_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id")


first_draft_unsigned_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 1)

avg_round_20_hs <- first_draft_unsigned_20 %>%
  summarize(mean_round = round(mean(draft_round), 2))%>%
  pull(mean_round)

count_unsigned_20 <- first_draft_unsigned_20 %>%
  count() %>%
  pull(n)

redrafted_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 2)
  
avg_round_redrafted_20 <- redrafted_20 %>%
  summarize(mean_round = round(mean(draft_round),2)) %>%
  pull(mean_round)

count_redrafted_20 <- redrafted_20 %>%
  count() %>%
  pull(n)

percent_redrafted_20 <- round(count_redrafted_20 / count_unsigned_20 * 100, 1)

percent_redrafted_20
}

```


```{r}

full_redraft_percent <- function(startyear, endyear = startyear + 4) {


hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

count_unsigned_hs <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & year <= endyear) %>%
  count() %>%
  pull(n)

trimyear_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & year <= endyear) %>%
  select(player_id)

count_redrafted_hs <- trimyear_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id") %>%
  filter(draft_numb == 2) %>%
  count() %>%
  pull(n)

percent_redrafted_hs <- round(count_redrafted_hs / count_unsigned_hs * 100, 1)

percent_redrafted_hs

}

full_redraft_percent(1990, 2015)

```

```{r}
round_redraft_percent <- function(startyear, endyear = startyear + 4, rounds = 20) {
  
hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

unsigned_hs_20_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & draft_round <= rounds & year <= endyear) %>%
  select(player_id)

hs_unsigned_20 <- unsigned_hs_20_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id")

first_draft_unsigned_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 1)

count_unsigned_20 <- first_draft_unsigned_20 %>%
  count() %>%
  pull(n)

redrafted_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 2)

count_redrafted_20 <- redrafted_20 %>%
  count() %>%
  pull(n)

percent_redrafted_20 <- round(count_redrafted_20 / count_unsigned_20 * 100, 1)

percent_redrafted_20

}

round_redraft_percent(2005, 2009, 5)

```


```{r}
prior_mean_round <- function(startyear, endyear = startyear + 4, rounds = 20) {
  
hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

unsigned_hs_20_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & draft_round <= rounds & year <= endyear) %>%
  select(player_id)

hs_unsigned_20 <- unsigned_hs_20_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id")

first_draft_unsigned_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 1)

avg_round_20_hs <- first_draft_unsigned_20 %>%
  summarize(mean_round = round(mean(draft_round), 2))%>%
  pull(mean_round)

avg_round_20_hs

}

prior_mean_round(1990, 2015, 20)
```

```{r}
post_mean_round <- function(startyear, endyear = startyear + 4, rounds = 20) {
  
hs_unsigned_trimyear <- hs_unsigned %>%
  filter(year >= startyear)

unsigned_hs_20_ids <- hs_unsigned_trimyear %>%
  filter(draft_numb == 1 & draft_round <= rounds & year <= endyear) %>%
  select(player_id)

hs_unsigned_20 <- unsigned_hs_20_ids %>%
  left_join(hs_unsigned_trimyear, by = "player_id")

redrafted_20 <- hs_unsigned_20 %>%
  filter(draft_numb == 2)
  
avg_round_redrafted_20 <- redrafted_20 %>%
  summarize(mean_round = round(mean(draft_round),2)) %>%
  pull(mean_round)

avg_round_redrafted_20
  
}

post_mean_round(1990, 2015, 20)

```


```{r}

# I made the master redraft_table in this chunk. Started by making a half-decade
# list from 1990 through 20010 which each serve to hold the data for that draft
# and the four following it. I made a tibble starting with these years and added
# a round column. Next, I added a percent redrafted percent column for all
# players who were drafted out of high school and turned it down in that time
# period. I then added a percent redrafted column for players drafted within the
# top 20 rounds of high school within that time period who turned down the draft
# to see the proportion that were redrafted. Finally, I took the same players'
# average initial draft round out of high school, their average draft round the
# next time they were picked, and the difference between them to see how their
# stock changed. I repeated the process for top 10 round high school picks and
# top 5 round high school picks, and then binded the three tables into a single
# table, redraft_table. The table stores the draft year period (2010-2014), high
# school draft round maximum (20th round), percent redrafted of all high school
# players in the period to turn down the draft, percent redrafted of high school
# players drafted before the round cutoff out of high school in the period,
# initial mean draft round, next mean draft round, and difference between the
# two slots.

half_decade <- c(1990, 1995, 2000, 2005, 2010)
half_decade <- set_names(half_decade, nm = half_decade)

redraft_table_20 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 20) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    rounds = 20), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    rounds = 20),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    rounds = 20),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)
  
  
redraft_table_10 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 10) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    rounds = 10), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    rounds = 10),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    rounds = 10),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)

redraft_table_05 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 5) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    rounds = 5), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    rounds = 5),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    rounds = 5),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)

redraft_table_50 <- tibble(start_year = c(1990, 1995, 2000, 2005, 2010)) %>%
  mutate(round = 50) %>%
  mutate(percent_redrafted = map_dbl(half_decade, ~round_redraft_percent(
    startyear = .,
    rounds = 50), 
    .id = half_decade)) %>%
  mutate(initial_draft_round = map_dbl(half_decade, ~prior_mean_round(
    startyear = .,
    rounds = 50),
    .id = half_decade)) %>%
  mutate(redraft_round = map_dbl(half_decade, ~post_mean_round(
    startyear = .,
    rounds = 50),
    .id = half_decade)) %>%
  mutate(mean_round_diff = initial_draft_round - redraft_round)

redraft_table <- rbind(redraft_table_50, redraft_table_20, redraft_table_10, redraft_table_05)

# order table by round descending and start year ascending to return to standard


```











